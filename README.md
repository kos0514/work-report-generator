# 作業報告書管理システム

## 前提
- Windowsの際は、Excelで作業報告書の時間を入力できていたのですが、Macに買い替えてからは、毎日入力する手段がなくなりました。
- いちいちWindowsPCを起動して入力するのはとても辛いため、MacでCSVを流し込むことで、作業報告書の入力を実現。
- それでも月1日は、windowsPCを起動して最終確認が必要な気がしますが、まあ良いとします。
- なにかいい方法があれば、あっぷでーとしていきたいです。

### 補足
- 仕様書を下記に配置し、基本的にJetBrainsのJunieでVibeコーディングしました。
  - docs/SPECIFICATION.md

## 概要
作業報告書管理システムは、Spring Boot + Spring Shellを使用したCLIベースのアプリケーションです。このシステムを使用することで、作業報告書の作成と更新を簡単に行うことができます。

## 機能
- 新規作業報告書ファイルの作成（Excelファイルと対応するCSVファイルを自動生成）
- CSVファイルからの作業報告書の更新
- 祝日対応（内閣府提供の祝日データ使用）
- 最新のCSVファイルを対応するExcelファイルに自動適用
- Excelファイルのパスワード付きZIP圧縮と送信機能

## 動作環境
- Java 21
- Spring Boot 3.5.0
- Spring Shell 3.4.0
- Gradle

## インストール方法

### 前提条件
- Java 21がインストールされていること
- Gradleがインストールされていること（または付属のGradleラッパーを使用）

### セットアップ手順
1. リポジトリをクローンまたはダウンロードします
2. `local-data/templates/` ディレクトリに作業報告書のテンプレートファイル（`作業報告書.xls`）を配置します

## 使用方法

### アプリケーションの起動
```bash
./gradlew bootRun
```
起動後、以下のようなCLIプロンプトが表示されます：
```
shell:>
```

### 基本コマンド

#### 新規報告書ファイルの作成
```bash
shell:> create-file --month 2025/06 --user "田中太郎" --client "株式会社サンプル"
```
**パラメータ**:
- `--month`: 対象月（YYYY/MM形式）
- `--user`: ユーザー名
- `--client`: クライアント名

**処理内容**:
- テンプレートファイルをコピー
- Excelファイル名: `田中太郎_202506_作業報告書.xls`
- CSVファイル名: `202506_work_data.csv`
- 基本情報（対象月、クライアント、ユーザー名）を設定
- 平日（土日祝日以外）の日付に対してデフォルトの開始時刻、終了時刻、休憩時間を設定
- 同時に、平日の日付、デフォルト時間を含むCSVファイルを自動生成
- 生成されたExcelファイルは `local-data/output/` ディレクトリに保存されます
- 生成されたCSVファイルは `local-data/csv/` ディレクトリに保存されます

#### CSVファイルからの報告書更新
```bash
shell:> update-file --file "田中太郎_202506_作業報告書.xls" --csv "work_data.csv"
```
**パラメータ**:
- `--file`: 更新対象のExcelファイル名
- `--csv`: 入力CSVファイル名（`local-data/csv/` ディレクトリ内）

**処理内容**:
- 指定されたExcelファイルをCSVデータで更新
- 日付をキーとして該当行を特定・更新（開始時刻、終了時刻、休憩時間、作業内容）
- CSVファイルに含まれない日付の行は自動的にクリアされます
- 更新後、時間計算式が自動的に実行され、合計時間などが再計算されます

#### 最新のCSVファイルを適用
```bash
shell:> save
```
**処理内容**:
- 最新のCSVファイルを対応するExcelファイルに自動的に適用します
- 年月が一致するExcelファイルとCSVファイルを自動的に検出して更新します
- 複数のファイルが更新された場合、更新件数が表示されます

#### Excelファイルの送信
```bash
shell:> send --file "田中太郎_202506_作業報告書.xls"
```
**パラメータ**:
- `--file`: 送信するExcelファイル名（省略時は最新のファイルを使用）

**処理内容**:
- 指定されたExcelファイルをパスワード付きZIPファイルに圧縮します
- 送信先ディレクトリに保存します（初回実行時は送信先ディレクトリの入力を求められます）
- パスワードは自動生成され、画面に表示されるとともに専用ディレクトリに保存されます
- メール送信設定を確認します（初回実行時はメール送信の有無を確認します）
- メールテンプレートを使用して、送信先ディレクトリの `work/yyyy/yyyymm` フォルダにメール文面を生成します

#### ヘルプ表示
```bash
shell:> help
```
コマンド一覧とヘルプ情報を表示します。

### CSVファイルの形式
CSVファイルは以下の形式で作成してください：
```csv
日付,開始時刻,終了時刻,休憩時間,作業内容
2025/06/02,09:30,17:45,1:00,システム設計書作成
2025/06/03,10:00,18:30,1:00,プログラム実装
2025/06/04,09:00,17:00,1:00,テスト実行
```

CSVファイルは `local-data/csv/` ディレクトリに配置してください。サンプルファイル `sample_work_data.csv` を参考にしてください。

## ディレクトリ構成
- `local-data/templates/` - Excelテンプレートファイル
  - `作業報告書.xls` を配置
- `local-data/output/` - 生成された作業報告書ファイル
- `local-data/csv/` - CSV入力ファイル
- `local-data/config/` - 設定ファイル
  - `send-config.properties` - 送信設定
- `local-data/mail/` - メールテンプレートファイル
  - `mail_template.txt` - メール文面のテンプレート

## 設定

### アプリケーション設定
設定は `application.yml` ファイルで行います：
```yaml
work-report:
  template-file: ./local-data/templates/作業報告書.xls
  output-dir: ./local-data/output
  csv-dir: ./local-data/csv
  holidays-file: classpath:config/syukujitsu.csv
```

### 送信設定
送信機能を使用する場合、初回実行時に送信先ディレクトリの入力を求められます。この設定は `local-data/config/send-config.properties` ファイルに保存され、次回以降は自動的に使用されます。

送信設定を変更する場合は、このファイルを直接編集するか、`send-config.properties` ファイルを削除して再度 `send` コマンドを実行してください。

### メールテンプレート設定
`send` コマンドを実行すると、メールテンプレートを使用して送信先ディレクトリの `work/yyyy/yyyymm` フォルダにメール文面が生成されます。メールテンプレートは `local-data/mail/mail_template.txt` ファイルに保存されています。

メールテンプレートファイルは以下の3つのセクションで構成されています：
1. メール件名
2. メール本文
3. パスワードメール本文

各セクションは `--------` で区切られています。

テンプレート内では以下の変数が使用できます：
- `${yearMonth}`: 送信年月（例：2025年06月）
- `${deadline}`: 翌月の第2営業日（例：2025年07月02日(水)）
- `${password}`: 自動生成されたZIPファイルのパスワード

メールテンプレートの例：
```
【${yearMonth}：作業報告書の承認依頼】フルーツチーム_ミカン 太郎
--------
リンゴシステムズ メロン様、パイナップル様

お世話になっております。バナナテクノロジーのミカン 太郎です。

${yearMonth}、稼働分の作業報告書をお送りいたします。
恐れ入りますが、記載内容に問題がないか、ご確認お願いいたします。

問題なければ、承認の旨のご連絡をお願いいたします。
※大変恐れ入りますが、${deadline} 18時までにご確認・ご返信をお願いいたします。（作業報告書は返信不要です）


Zipファイルのため、パスワードは次のメールでお送りいたします。
--------
リンゴシステムズ メロン様、パイナップル様

お世話になっております。バナナテクノロジーのミカン 太郎です。

先ほど、お送りしたZipファイルのパスワードをお送りいたします。

パスワード：${password}

以上、よろしくお願いします。
```

## 使用例

### 月次報告書作成フロー
1. アプリケーションを起動
   ```bash
   ./gradlew bootRun
   ```

2. 新規ファイルを作成
   ```bash
   shell:> create-file --month 2025/06 --user "田中太郎" --client "株式会社サンプル"
   ```
   出力: 
   ```
   ファイル作成完了:
   - Excel: 田中太郎_202506_作業報告書.xls
   - CSV: 202506_work_data.csv
   ```

3. 自動生成されたCSVファイルを編集（外部エディタで）
   - 自動生成されたCSVファイル `202506_work_data.csv` には平日の日付とデフォルト時間が既に設定されています
   - 必要に応じて時間や作業内容を編集してください
   - フォーマット: 日付,開始時刻,終了時刻,休憩時間,作業内容
   - ファイルは既に `local-data/csv/` ディレクトリに保存されています

4. CSVデータで報告書を更新
   ```bash
   shell:> save
   ```
   出力: `更新完了: 15 件`

5. 完了！ファイルは `local-data/output/` に保存されています

6. ファイルを送信する（オプション）
   ```bash
   shell:> send --file "田中太郎_202506_作業報告書.xls"
   ```
   出力:
   ```
   ファイルを送信しました:
   - 元ファイル: 田中太郎_202506_作業報告書.xls
   - ZIP: /path/to/send/directory/田中太郎_202506_作業報告書.zip
   - パスワード: a1b2c3d4
   - メール文面保存先: /path/to/send/directory/work/2025/202506
   - メール送信: 有効
   ```

## エラーハンドリング
- **テンプレートファイルなし**: テンプレートファイルが見つからない場合、エラーメッセージが表示されます
- **CSV形式エラー**: CSVの形式が正しくない場合、行番号付きのエラーが表示されます
- **日付不一致**: CSVに含まれる日付が対象月に存在しない場合、その行はスキップされます
- **ファイル権限エラー**: ファイルの読み書き権限がない場合、権限問題の解決方法が提示されます
- **メールテンプレートエラー**: メールテンプレートファイルが見つからない場合、または形式が正しくない場合、エラーメッセージが表示されます

## セキュリティ
このプロジェクトでは、依存関係の脆弱性を自動的に検出し、修正するための仕組みを導入しています。

### 脆弱性検出と自動更新
- **Dependabot**: 依存関係の脆弱性を自動的に検出し、修正のためのプルリクエストを作成します
  - 週次で依存関係をチェックし、脆弱性が見つかった場合は優先的に更新します
  - セキュリティ修正のプルリクエストは自動的にマージされます（パッチバージョンの更新のみ）

### 依存関係レビュー
- プルリクエスト時に依存関係の変更をレビューし、重大な脆弱性がある場合は警告します
- 定期的に脆弱性スキャンを実行し、結果をGitHub Security Alertsに報告します

### 手動での脆弱性チェック
依存関係の脆弱性を手動でチェックするには、以下のコマンドを実行します：
```bash
./gradlew dependencyCheckAnalyze
```
結果は `build/reports/dependency-check-report.html` に出力されます。
